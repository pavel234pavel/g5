---
title: "g5_Гладышев П.С."
editor_options:
  chunk_output_type: console
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
  word_document:
    toc: yes
lang: ru-RU
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Библиотеки
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(rio)
library(tidyverse)
library(skimr)
library(ggplot2)
library(dplyr)
library(lubridate)
```


# База данных
Для удобства и наглядности построю некоторое подобие базы, которая содержит следующиую информацию: 
User_ID - уникальный идентификатор пользователя. Предположим, что в игре  на момент проведения исследования (21.03.2018) зарегистрировано 1000 пользователей.
Reg_Date - дата регистрации в игре. Предположим релиз состоялся 01.01.2017
Date - дата за которую производится наблюдение
Revenue - сумма покупки в центах, которая была уплачена игроком
Revenue_gcent - сумма в игровой валюте, которая была куплена игроком
Platform -платформа
С помощью этой таблицы буду отвечать на вопросы.

Таблица 1. Предположим база данных пользователей содержит 1000 записей, которые включают User_ID пользователя (1-1000) и дату регистрации (01.01.2017-17.03.2018, рандомно) и платформу (рандомно) 
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
set.seed(777)
df1 = data.frame(User_ID = 1:1000, Reg_date = arrange((data.frame(Reg_date = (sample(seq(as.Date('2017/01/01'), as.Date('2018/03/17'), by="day"), size = 1000, replace = TRUE)))), Reg_date)$Reg_date, Platform = sample(c("Android", "iOS", "Windows"), size = 1000, replace = TRUE))
```

Таблица 2.Предположим за исследуемый период (01.03.2018-17.03.2018) пользователями из Таблицы 1 было совершено 300 транзакций
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
set.seed(777)
df2 = left_join(data.frame(User_ID = sample(1:1000, size = 300, replace = TRUE)), df1, by = "User_ID")
```

Таблица 3. Добавим столбец "Date" (01.03.2018-21.03.2018) - дата транзакции
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
df3 =arrange(mutate(df2, Date = sample(seq(as.Date('2018/03/01'), as.Date('2018/03/17'), by="day"), size = 300, replace = TRUE)), Date)
```

Таблица 4. и Таблица 5. Добавим столбцы "Revenue" - начислено cent и "Revenue_gcent" - начислено gcent.  Предположим игровая акция была приурочена к 8 марту 2018 года и длилась три дня (по условию).Суть акции заключалась в обмене центов (cent) на игровую валюту (gcent) по более выгодному курсу. Схема обмена во время акции: 250 cent = 500 gcent; 500 cent = 1500 gcent; 1000 cent = 4000 gcent. Стандартная схема обмена: 
100 cent = 100 gcent; 200 cent = 300 gcent; 400 cent = 800 gcent.
Рассматриваем период с первого по двадцать скмнадцатое марта, 01.03.2018-07.03.2018  11.03.2018-17.03.2018- ничем непримечательный игровой период, 08.03.2018-10.03.2018 - монетизационная акция.

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
df4 = mutate(df3, Revenue = c(sample(c(100, 200, 400), size = nrow(df3[df3[,c(4)] < "2018-03-08", ]), replace = TRUE),sample(c(250, 500, 1000), size = nrow(data.frame(test= df3[df3[,c(4)] < "2018-03-11", 4][df3[df3[,c(4)] < "2018-03-11", 4] > "2018-03-07"])), replace = TRUE), sample(c(100, 200, 400), size = nrow(df3[df3[,c(4)] > "2018-03-10", ]), replace = TRUE)))

sup_tab = data.frame(Revenue = c(100, 200, 400, 250, 500, 1000), Revenue_gcent = c(100, 300, 800, 500, 1500, 4000))

df5 = left_join(df4, sup_tab, by = "Revenue")

```

Итоговый вид базы:
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
head(df5)
```


# Задание 1
На игровом проекте компании в начале прошлого месяца была проведена монетизационная акция. Она длилась 3 дня. В рамках акции, игрокам предлагалось купить игровые ресурсы по более выгодным, чем обычно, ценам. При этом, стоимость акционного предложения была выше среднего чека по проекту. Перед Вами стоит задача провести анализ этой акции.Расскажите, как бы Вы проводили такой анализ? Желательно, чтобы ответ включал в себя следующее:

## - План, по которому хотели бы провести анализ. Интересуют все этапы, начиная со сбора данных и заканчивая презентацией выводов;
Сбор первичных данных - выгрузка из базы
Преобразование данных - отбросить неиспользуемые поля, очистка данных
Анализ - расчет необходимых статистик, оценка параметров
Демонстрация результатов

## - Какие метрики предполагается оценивать;
Доход за весь период акции
```{r}
sum_total_promot = sum(df5[df5[df5[, 4]< "2018-03-11", 4] > "2018-03-07", ]$Revenue)
sum_total_promot
```
Доход за день акции
```{r}
sum_perday_promot = sum_total_promot / 3
sum_perday_promot
```
Превышение доходности акционного дня над обычным днем в процентах
```{r}
sum_perday = sum(df5[df5[df5[, 4]< "2018-03-08", 4] > "2018-03-05", ]$Revenue) / 3
((sum_perday_promot / sum_perday) - 1) * 100
```
Средний чек в период акции
```{r}
avg_cheque_promot = sum(df5[df5[df5[, 4]< "2018-03-11", 4] > "2018-03-07", ]$Revenue) / nrow(df5[df5[df5[, 4]< "2018-03-11", 4] > "2018-03-07", ])
avg_cheque_promot
```
Доходность по дням;определение наиболее активных покупателей в разрезе регионов; количество игроков, которые впервые осуществили покупку; количество зарегестрированных в период акции игроков и др.

## - Предполагается ли сегментация аудитории проекта. Если да, то какая и какую цель она преследует;
Можно разделить игровое комьюнити на  игроков-донатеров и игроков, не совершивших покупок в игре. Для первой группы необходимо решать задачу об увеличении количества покупок на игрока, для второй группы можно исследовать причины, по которым игроки избегают использовать внутриигровой рынок. Также можно рассматривать пользователей в разрезе проведенного времени в игре (новый игрок / опытный игрок), регионалной принадлежности и пр.  

## - Планируется ли визуализация итоговых данных. Если да, то какими методами (какие виды графиков и что они будут отражать).
Количество покупок в период акции
```{r}
prom = df5[df5[df5[, 4]< "2018-03-11", 4] > "2018-03-07", ]
nrow(prom)
```
Количество покупателей в период акции
```{r}
df6 = group_by(mutate(prom, test_col1 = 1), User_ID) %>% summarise(nrow1 = sum(Revenue), nrow2 = sum(test_col1))
nrow(df6)
```
Количество покупателей в разрезе количества совершенных ими покупок в период акции
```{r}
df7 = mutate(df6, test_col2 = 1)
df8 = group_by(df7, nrow2) %>% summarise(nrow3 = sum(test_col2))
pie <- ggplot(df7, aes(x = "", fill = factor(nrow2))) + 
  geom_bar(width = 1) +
  theme(axis.line = element_blank(), 
        plot.title = element_text(hjust=0.5)) + 
  labs(fill="Количество
транзакций", 
       x=NULL, 
       y=NULL, 
       title="Разбиение покупателей 
по степени активности")
pie + coord_polar(theta = "y", start=0)
```

Мартовсие продажи
```{r}
df10 = mutate(df5, testcol1 = 1)
df11 = group_by(df10, Date) %>% summarise(quantity_payment = sum(testcol1), sum_payment = sum(Revenue))
plot2 = ggplot(df11, aes(x = Date)) + 
  geom_line(aes(y = sum_payment)) + 
  labs(title="Продажи", 
       subtitle="01.03.2018-17.03.2018",
       y="Revenue") +
  scale_x_date(labels = seq(as.Date('2018/03/01'), as.Date('2018/03/17'), by="day"), 
               breaks = seq(as.Date('2018/03/01'), as.Date('2018/03/17'), by="day")) +
  theme(axis.text.x = element_text(angle = 30, vjust=0.5),
                              panel.grid.minor = element_blank())
plot2

```
И многое многое другое....





#Задание 2:
Допустим,Вам были предоставлены данные о монетизационной акции, описанной в Задании 1. Данные содержат информацию об активности пользователей, заходивших в приложение за неделю до акции, во время акции, а также за неделю после окончания акции. Данные предоставлены в следующем формате:
Группирующие колонки:
Date -дата, за которую производится наблюдение;
Platform -платформа, на которой играет пользователь (iOS, Android,Windows и т.д.);
User_ID - уникальный идентификатор пользователя;
Reg_Date -дата регистрации пользователя в приложении;
Расчетные колонки:
Revenue -сколько центов заплатил пользователь зарассматриваемую дату;
Payments - сколько платежей совершил пользователь за рассматриваемую дату;
Sessions - сколько сессий было у пользователя за рассматриваемую
дату;
Playing_Time- сколько времени пользователь провел в игре за 
рассматриваемую дату.

## Имея такие данные на руках, как бы вы ответили на следующие вопросы: Какие полезные метрики, описывающие проект и позволяющие оценить эффект монетизационной акции, можно рассчитать на основе этих  данных.
Средний чек (Revenue) в разрезе платформы (Platform)
Время "зарегестрированности" в среднем (Reg_Date) у наиболее активных игроков(Sessions)
Взаимосвяь между количеством сессий (Sessions) и количеством платежей (Payments)
## Опишите, как бы Вы считали эти метрики, используя ваш любимый инструмент (R/Python/Excel/Other).

Средний чек (Revenue) в разрезе платформы (Platform) за время акции
```{r}
avg_df = mutate(df5, testcol = 1)
avg1 = group_by(avg_df, Platform) %>% summarise(sum_Revenue_Platform = sum(Revenue), quantity_Platform = sum(testcol)) %>% mutate(avg_Platform = sum_Revenue_Platform / quantity_Platform)
avg1[c(1, 4)]
```
Cреднее время "зарегестрированности" (Reg_Date) у наиболее активных игроков(Sessions)
Отсортировать по неубыванию (Sessions) %>% Взять 10% верхних %>% Расчитать для данной выборки время среднее время с момета регистрации 
Взаимосвяь между количеством сессий (Sessions) и количеством платежей (Payments)
Через коэффициент корреляции
## Опишите, как бы Вы осуществили визуализацию рассчитанных метрик.
Средний чек (Revenue) в разрезе платформы (Platform) за время акции - гистограмма
Cреднее время "зарегестрированности" (Reg_Date) у наиболее активных игроков(Sessions) - вафельная диаграмма
Взаимосвяь между количеством сессий (Sessions) и количеством платежей (Payments) -  диаграмма рассеяния

## Вслучае использования в работе языков программирования (R или  Python), опишите, какие библиотеки Вы применяли бы и приведите примеры  кода.
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(corrplot)
```



#Задание 3:
Теперь представим другую ситуацию. К Вам обратился отдел, занимающийся закупкой рекламного трафика для наших приложений (User Acquisition).Для планирования своих расходов и построения KPI, им необходимо иметь возможность прогнозировать доходы по когортам закупаемого трафика. Конкретно, их интересует прогноз накопительного LTV (Lifetime Value) за первые 60 дней жизни когорты. Крайне желательно предоставить им прогноз на каждый день (с 1 по 60), а не только на 60-й.В базе данных имеется информация о том, по какой реферальной ссылке 
пользователь пришел в игру, на какой платформе он играет, в какой стране 
находится, а также многие другие факторы, которые можно использовать при 
прогнозировании LTV.
Ответьте в свободной форме и в любом порядке на следующие вопросы:

## Опишите, как бы Вы рассчитывали такой прогноз?
Построил бы  модель множественной регрессии 

## Какими инструментами Вы пользовались бы (Excel/R/Python/Other)?
R/Python

## Какие математические подходы Вы применили бы для решения данной задачи?
Регрессионно корреляционный анализ, кластеризация


#Задание 4:
Представим, что отделу UA очень понравились Ваши прогнозы и они пришли к Вам с более сложной и интересной задачей. Допустим, они хотят оптимизировать закупки пользователей. Их цель - приводить в игру таких игроков, которые бы лучше остальных вовлекались в игровой процесс, лучше оставались в игре и, разумеется, лучше платили.При этом, партнеры, у которых отдел UA закупает трафик, поддерживают такую функцию, как“look alike” или “искать похожих”. Т.е. если отдать этой системе ID игроков, которые хорошо показали себя в наших приложениях, данная система, по идее, должна привести нам еще таких же пользователей.
Поэтому, отдел UA пришел к Вас с просьбой локализовать таких пользователей в отдельно взятом нашем приложении, ID которых можно было бы использовать для этой системы поиска “look alike”. Ответьте в свободной форме и в любом порядке на следующие вопросы:

## По каким критериям Вы бы разделяли игроков на “хороших” и“плохих”, на “подходящих” и “неподходящих”? Сколько вообще групп Вы бы выделили? Только две или более?
Две группы достаточно - “подходящие” и “неподходящие”. К группе "подходящих" имеет смысл относить лояльных (с высокими средним Sessions), опытных (по Reg_Date), делающих покупки (с высоким совокупным Payments) игроков. "Неподходящие" - иные.

## Какими инструментами Вы бы пользовались для решения данной задачи?
R/Python
Кластерный анализ

## Опишите в общих чертах, как именно Вы проводили бы анализ имеющихся данных?
Самое простое - Сделал бы выборку из базы пользователей значения показателей по отобранным критериям которых выше средней или медианы по генеральной совокупности

